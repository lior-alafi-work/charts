suite: Test nodeAnalyzer CA cert
templates:
  - secrets.yaml
  - daemonset-node-analyzer.yaml
tests:
  - it: Checking nodeAnalyzer CA Cert Secret
    set:
      documentIndex: 0
      nodeAnalyzer.benchmarkRunner.deploy: true
      nodeAnalyzer.imageAnalyzer.deploy: true
      nodeAnalyzer.hostAnalyzer.deploy: true
      nodeAnalyzer.hostScanner.deploy: true
      nodeAnalyzer.runtimeScanner.deploy: true
      sysdig:
        accessKey: AAAAAAAA-BBBB-CCCC-DDDD-EEEEEEEEEEEE
      ssl:
        ca:
          cert: |
            -----BEGIN CERTIFICATE-----
            my-test-cert
            -----END CERTIFICATE-----
          fileName: "root_ca.crt"
    asserts:
      - isKind:
          of: Secret
        template: secrets.yaml
  - it: Check Local CA Cert
    set:
      documentIndex: 0
      nodeAnalyzer.benchmarkRunner.deploy: true
      nodeAnalyzer.imageAnalyzer.deploy: true
      nodeAnalyzer.hostAnalyzer.deploy: true
      nodeAnalyzer.hostScanner.deploy: true
      nodeAnalyzer.runtimeScanner.deploy: true
      sysdig:
        accessKey: AAAAAAAA-BBBB-CCCC-DDDD-EEEEEEEEEEEE
      ssl:
        ca:
          cert: |
            -----BEGIN CERTIFICATE-----
            my-test-cert
            -----END CERTIFICATE-----
          fileName: "root_ca.crt"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SSL_CERT_FILE
            value: "/ca-certs/root_ca.crt"
        template: daemonset-node-analyzer.yaml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: ca-cert
            secret:
              secretName: release-name-node-analyzer-ca
        template: daemonset-node-analyzer.yaml
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: ca-cert
            mountPath: /ca-certs
        template: daemonset-node-analyzer.yaml
  - it: Check Global CA Cert with local CA cert override
    set:
      documentIndex: 0
      nodeAnalyzer.benchmarkRunner.deploy: true
      nodeAnalyzer.imageAnalyzer.deploy: true
      nodeAnalyzer.hostAnalyzer.deploy: true
      nodeAnalyzer.hostScanner.deploy: true
      nodeAnalyzer.runtimeScanner.deploy: true
      global:
        ssl:
          ca:
            cert: |
              -----BEGIN CERtIFICATE-----
              my-test-cert
              -----END CERtIFICATE-----
            fileName: "global_root_ca.crt"
      sysdig:
        accessKey: AAAAAAAA-BBBB-CCCC-DDDD-EEEEEEEEEEEE
      ssl:
        ca:
          cert: |
            -----BEGIN CERtIFICATE-----
            my-test-cert
            -----END CERtIFICATE-----
          fileName: "root_ca.crt"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SSL_CERT_FILE
            value: "/ca-certs/root_ca.crt"
        template: daemonset-node-analyzer.yaml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: ca-cert
            secret:
              secretName: release-name-node-analyzer-ca
        template: daemonset-node-analyzer.yaml
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: ca-cert
            mountPath: /ca-certs
        template: daemonset-node-analyzer.yaml
  - it: Check Global CA Cert
    set:
      documentIndex: 0
      nodeAnalyzer.benchmarkRunner.deploy: true
      nodeAnalyzer.imageAnalyzer.deploy: true
      nodeAnalyzer.hostAnalyzer.deploy: true
      nodeAnalyzer.hostScanner.deploy: true
      nodeAnalyzer.runtimeScanner.deploy: true
      global:
        ssl:
          ca:
            cert: |
              -----BEGIN CERtIFICATE-----
              my-test-cert
              -----END CERtIFICATE-----
            fileName: "global_root_ca.crt"
      sysdig:
        accessKey: AAAAAAAA-BBBB-CCCC-DDDD-EEEEEEEEEEEE
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SSL_CERT_FILE
            value: "/ca-certs/global_root_ca.crt"
        template: daemonset-node-analyzer.yaml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: ca-cert
            secret:
              secretName: RELEASE-NAME-global-ca
        template: daemonset-node-analyzer.yaml
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: ca-cert
            mountPath: /ca-certs
        template: daemonset-node-analyzer.yaml
